{% extends "base.html" %}
{% load static %}
{% block styles %}
<!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Roboto:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Progress Bar */
        .progress-bar {
            padding: 30px 0;
            text-align: center;
        }

        .progress-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            max-width: 400px;
            margin: 0 auto;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .progress-step.completed {
            color: #27ae60;
        }

        .progress-step.active {
            color: #f39c12;
        }

        .progress-step.pending {
            color: #6c757d;
        }

        .progress-separator {
            color: #dee2e6;
            font-size: 12px;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title {
            font-family: 'Playfair Display', serif;
            font-size: 36px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Main Content */
        .checkout-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        /* Form Sections */
        .checkout-form {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .form-section {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            color: #f39c12;
        }

        /* Form Groups */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: white;
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            background: #fafbfc;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background-color: white;
        }

        /* Payment Options */
        .payment-options {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
        }

        .payment-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .payment-radio {
            width: 18px;
            height: 18px;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            position: relative;
            cursor: pointer;
        }

        .payment-radio.checked {
            border-color: #3498db;
        }

        .payment-radio.checked::after {
            content: '';
            width: 8px;
            height: 8px;
            background: #3498db;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .payment-label {
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
        }

        /* Order Summary */
        .order-summary {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .summary-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-item {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f1f3f4;
        }

        .order-item:last-of-type {
            border-bottom: none;
            margin-bottom: 24px;
        }

        .item-image {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .item-details {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .item-author {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .item-quantity {
            font-size: 12px;
            color: #6c757d;
        }

        .item-price {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .summary-label {
            color: #6c757d;
        }

        .summary-value {
            font-weight: 500;
            color: #2c3e50;
        }

        .summary-total {
            border-top: 1px solid #f1f3f4;
            padding-top: 16px;
            margin-top: 16px;
        }

        .summary-total .summary-label,
        .summary-total .summary-value {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #495057;
            border: 2px solid #e1e5e9;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Security Info */
        .security-info {
            text-align: center;
            margin-top: 20px;
        }

        .security-text {
            font-size: 12px;
            color: #27ae60;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .payment-icons {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .payment-icon {
            width: 32px;
            height: 22px;
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #495057;
            font-weight: 600;
        }

        .payment-icon.visa {
            background: #1a1f71;
            color: white;
        }

        .payment-icon.mastercard {
            background: #eb001b;
            color: white;
        }

        .payment-icon.discover {
            background: #ff6000;
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .checkout-content {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .form-section,
            .order-summary {
                padding: 24px 20px;
            }

            .progress-steps {
                flex-direction: column;
                gap: 10px;
            }

            .progress-separator {
                transform: rotate(90deg);
            }

            .page-title {
                font-size: 28px;
            }

            .container {
                padding: 0 15px;
            }

            .payment-options {
                flex-direction: column;
                gap: 12px;
            }
        }

        @media (max-width: 480px) {
            .order-item {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .item-image {
                width: 50px;
                height: 70px;
            }
        }

    </style>
{% endblock styles %} 
{% block page %}
    
    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-steps">
                <div class="progress-step completed">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Cart</span>
                </div>
                <div class="progress-separator">
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="progress-step active">
                    <i class="fas fa-credit-card"></i>
                    <span>Checkout</span>
                </div>
                <div class="progress-separator">
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="progress-step pending">
                    <i class="fas fa-check-circle"></i>
                    <span>Complete</span>
                </div>
            </div>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Checkout</h1>
        </div>

        <!-- Main Content -->
        <form method="POST" id="checkoutForm">
            {% csrf_token %}
        <div class="checkout-content">
            <!-- Checkout Form -->
                <div class="checkout-form">
                
                    <!-- Contact Information -->
                    <div class="form-section">
                        <h2 class="section-title">
                            <i class="fas fa-user section-icon"></i>
                            Contact Information
                        </h2>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName" class="form-label">First Name</label>
                                <p id="firstName" class="form-input">{{user.first_name}}</p>
                            </div>
                            <div class="form-group">
                                <label for="lastName" class="form-label">Last Name</label>
                                <p id="lastName" class="form-input">{{request.user.last_name}}</p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="email" class="form-label">Email Address</label>
                            <p id="email" class="form-input">{{request.user.email}}</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" id="phone" class="form-input" name="p_number" placeholder="+923123456789" required>
                        </div>
                    </div>

                <!-- Shipping Address -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-truck section-icon"></i>
                        Shipping Address
                    </h2>
                    
                    <div class="form-group">
                        <label for="streetAddress" class="form-label">Street Address</label>
                        <input type="text" id="streetAddress" class="form-input" name="strAddr" placeholder="123 Main Street" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city" class="form-label">City</label>
                            <input type="text" id="city" class="form-input" name="city" placeholder="Lahore" required>
                        </div>
                        <div class="form-group">
                            <label for="state" class="form-label">State</label>
                            <input type="text" id="state" class="form-input" name="state" placeholder="Punjab" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="zipCode" class="form-label">ZIP Code</label>
                            <input type="text" id="zipCode" name="zip_code" class="form-input" placeholder="10001" required>
                        </div>
                        <div class="form-group">
                            <label for="country" class="form-label">Country</label>
                            <input type="text" id="country" class="form-input" name="country" placeholder="Pakistan" required>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-credit-card section-icon"></i>
                        Payment Information
                    </h2>
                    
                    <div id="jazzcashInfo" style="text-align:center; margin-top:1em;">
                        <p>You'll be redirected to JazzCash secure sandbox payment page.</p>
                    </div>

                </div>

            </div>

            <!-- Order Summary -->
            <div class="order-summary">
                <h2 class="summary-title">
                    <i class="fas fa-receipt section-icon"></i>
                    Order Summary
                </h2>

                <button class="btn btn-primary" type="submit">
                    <i class="fas fa-lock"></i>
                    Complete Order
                </button>
                
                <button class="btn btn-secondary" onclick="goBackToCart()">
                    <i class="fas fa-arrow-left"></i>
                    Back to Cart
                </button>

                <div class="security-info">
                    <div class="security-text">
                        <i class="fas fa-shield-alt"></i>
                        Secure SSL Encryption
                    </div>
                    <div class="payment-icons">
                        <div class="payment-icon visa">VISA</div>
                        <div class="payment-icon mastercard">MC</div>
                        <div class="payment-icon discover">DISC</div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    </div>

<script>
const allBooks = [
    {% for book in books %}
    {
        slug: "{{ book.slug }}",
        title: "{{ book.title|escapejs }}",
        author: "{{ book.author|escapejs }}",
        price: {{ book.price }},
        image_url: "{% if book.cover_image %}{{ book.cover_image.url }}{% else %}{% static 'books/silent.png' %}{% endif %}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

function renderCheckoutCart() {
    const availableOffers = [
        {% for offer in offers %}
            { min_books: {{ offer.min_books }}, discount: {{ offer.discount_percent }} }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const username = "{{ request.user.username }}";
    const cartArray = JSON.parse(localStorage.getItem("cart") || "[]");
    const userCart = cartArray.filter(item => item.username === username);

    const summaryContainer = document.querySelector(".order-summary");
    //discounts setup
    let discount = 0;
    let bestOffer = null;

    let totalQuantity = 0;
    userCart.forEach(item => totalQuantity += item.quantity);

    availableOffers.forEach(offer => {
        if (totalQuantity >= offer.min_books && offer.discount > discount) {
            discount = offer.discount;
            bestOffer = offer;
        }
    });

    let subtotal = 0;
    let discountVal = discount;
    let taxRate = 0.0875;
    let summaryItemsHTML = "";
    let hiddenInputs = "";

    userCart.forEach(({ slug, quantity }) => {
        const book = allBooks.find(b => b.slug === slug);
        if (!book) return;

        const itemTotal = quantity * book.price;
        subtotal += itemTotal;

        summaryItemsHTML += `
            <div class="order-item">
                <img src="${book.image_url}" alt="${book.title}" class="item-image">
                <div class="item-details">
                    <div class="item-title">${book.title}</div>
                    <div class="item-author">by ${book.author}</div>
                    <div class="item-quantity">Qty: ${quantity}</div>
                </div>
                <div class="item-price">$${itemTotal.toFixed(2)}</div>
            </div>
        `;

        // Repeat hidden inputs for each quantity
        for (let i = 0; i < quantity; i++) {
            hiddenInputs += `<input type="hidden" name="submittedBooks" value="${slug}">`;
        }
    });

    const tax = subtotal * taxRate;
    const discountAmount = (discountVal / 100) * subtotal;
    discountVal = discountAmount;
    const total = subtotal + tax - discountVal;

    hiddenInputs += `<input type="hidden" name="total_price" value="${total.toFixed(2)}">`;

    const summaryTotalsHTML = `
        <div class="summary-row"><span class="summary-label">Subtotal</span><span class="summary-value">$${subtotal.toFixed(2)}</span></div>
        <div style="color:rgb(245, 166, 9)" class="summary-row"><span class="summary-label">Discount (Auto applied best discounts)</span><span class="summary-value">$${discountVal.toFixed(2)}</span></div>
        <div class="summary-row"><span class="summary-label">Tax</span><span class="summary-value">$${tax.toFixed(2)}</span></div>
        <div class="summary-row summary-total"><span class="summary-label">Total</span><span class="summary-value">$${total.toFixed(2)}</span></div>
    `;

    summaryContainer.querySelectorAll('.order-item, .summary-row').forEach(e => e.remove());

    const titleElement = summaryContainer.querySelector(".summary-title");
    if (titleElement) {
        titleElement.insertAdjacentHTML("afterend", summaryItemsHTML);
    }

    const checkoutButton = summaryContainer.querySelector(".btn-primary");
    if (checkoutButton) {
        checkoutButton.insertAdjacentHTML("beforebegin", summaryTotalsHTML);
    }

    const form = document.getElementById("checkoutForm");
    if (form) {
        form.insertAdjacentHTML("beforeend", hiddenInputs);
    }
}

//document.addEventListener("DOMContentLoaded", renderCheckoutCart);
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("checkoutForm");
    const completeBtn = form.querySelector('.btn-primary');
    completeBtn.disabled = true;
    completeBtn.innerHTML = "Loading cart...";

    renderCheckoutCart();

    // After rendering is done, enable the button
    setTimeout(() => {
        completeBtn.disabled = false;
        completeBtn.innerHTML = `<i class="fas fa-lock"></i> Complete Order`;
    }, 200); // enough time for DOM updates
});

</script>
<noscript>
    <div style="background: #f44336; color: white; padding: 15px; margin: 20px 0; border-radius: 8px;">
        <strong>JavaScript is required</strong> for this page to work properly. Please enable JavaScript.
    </div>
</noscript>



{% endblock page %}   